# DelayedNotifier

DelayedNotifier — это сервис для отложенных уведомлений через очереди. Он позволяет создавать уведомления с указанием времени отправки, которые автоматически обрабатываются в фоне с использованием RabbitMQ. В случае ошибок отправки предусмотрены повторные попытки с экспоненциальной задержкой. Сервис поддерживает кэширование через Redis для быстрой проверки статуса и отправку через различные каналы (например, Telegram). Также включен простой веб-интерфейс для удобного тестирования.

## Описание

Во многих сервисах пользователям нужно напоминать о чём-то не сразу, а через какое-то время. Это могут быть уведомления о предстоящих встречах, напоминания о заказе, сообщения в мессенджере или email через несколько часов, дней и т.д. Вручную такие вещи не отправляют — этим занимается отдельный сервис, который умеет «запоминать», когда и кому нужно отправить сообщение, и делает это автоматически.

DelayedNotifier реализует такой сервис на Go с использованием PostgreSQL для хранения данных, RabbitMQ для очередей, Redis для кэширования и простого UI на HTML/JS.

## Функциональность

### Основные возможности
- **Создание уведомлений**: POST /notify — создание уведомлений с текстом, Telegram ID и временем отправки.
- **Получение статуса**: GET /notify/{id} — получение статуса уведомления по ID.
- **Отмена уведомлений**: DELETE /notify/{id} — отмена запланированного уведомления (установка статуса "canceled").
- **Фоновая обработка**: Уведомления отправляются в указанное время через очередь RabbitMQ. В случае ошибки — повтор с экспоненциальной задержкой.
- **Кэширование**: Использование Redis для быстрой проверки статуса уведомлений.
- **Отправка через каналы**: Поддержка отправки через Telegram (расширяемо для Email и других).
- **Простой UI**: Веб-интерфейс для создания, отмены и просмотра уведомлений без curl-запросов.

### Дополнительные эндпоинты
- **GET /notify**: Получение списка всех уведомлений.
- **GET /**: Главная страница с UI.

## Запуск проекта

### Требования
- Docker и Docker Compose
- .env файл с переменными окружения (пример ниже)

### Переменные окружения (.env)
Создайте файл `.env` в корне проекта:
```
DB_HOST=db
DB_PORT=5432
DB_USER=user
DB_PASSWORD=your_db_password
DB_NAME=delayed-notifier
GOOSE_DRIVER=postgres
GOOSE_MIGRATION_DIR=/migrations
BOT_TOKEN=
```

### Запуск
1. Клонируйте репозиторий.
2. Настройте `.env` файл.
3. Запустите сервисы:
   ```bash
   docker-compose up --build
   ```
4. Сервис будет доступен на `http://localhost:8080`.
5. UI доступно по адресу `http://localhost:8080/`.

## API Эндпоинты

### 1. Создание уведомления
**POST /notify**

Создает новое уведомление. Требуется JSON с текстом, Telegram ID и временем отправки (в будущем).

**Пример curl:**
```bash
curl -X POST http://localhost:8080/notify \
  -H "Content-Type: application/json" \
  -d '{
    "text": "Напоминание о встрече",
    "telegram_id": 123456789,
    "send_at": "2025-09-18T12:00:00Z"
  }'
```

**Ответ (успех):**
```json
{
  "id": 1,
  "text": "Напоминание о встрече",
  "status": "active",
  "telegram_id": 123456789,
  "send_at": "2025-09-18T12:00:00Z",
  "created_at": "2025-09-18T10:00:00Z"
}
```

**Ошибки:**
- 400: Неверный payload или время в прошлом.
- 500: Ошибка создания уведомления.

### 2. Получение статуса уведомления
**GET /notify/{id}**

Получает статус уведомления по ID.

**Пример curl:**
```bash
curl -X GET http://localhost:8080/notify/1
```

**Ответ (успех):**
```json
{
  "id": 1,
  "status": "active"
}
```

**Ошибки:**
- 400: Неверный ID или уведомление не найдено.
- 500: Ошибка получения статуса.

### 3. Отмена уведомления
**DELETE /notify/{id}**

Отменяет уведомление по ID (устанавливает статус "canceled").

**Пример curl:**
```bash
curl -X DELETE http://localhost:8080/notify/1
```

**Ответ (успех):**
```json
{
  "status": "notification was cancelled successfully"
}
```

**Ошибки:**
- 400: Неверный ID или уведомление не найдено.
- 500: Ошибка обновления статуса.

### 4. Получение всех уведомлений
**GET /notify**

Получает список всех уведомлений.

**Пример curl:**
```bash
curl -X GET http://localhost:8080/notify
```

**Ответ (успех):**
```json
[
  {
    "id": 1,
    "text": "Напоминание о встрече",
    "status": "active",
    "telegram_id": 123456789,
    "send_at": "2025-09-18T12:00:00Z",
    "created_at": "2025-09-18T10:00:00Z"
  }
]
```

**Ошибки:**
- 500: Ошибка получения уведомлений.

### 5. Главная страница (UI)
**GET /**

Возвращает HTML-страницу с формой для создания и управления уведомлениями.

**Пример curl:**
```bash
curl -X GET http://localhost:8080/
```

## Использование UI

1. Откройте `http://localhost:8080/` в браузере.
2. **Создание уведомления**: Заполните форму с текстом, Telegram ID и временем отправки, нажмите "Create Notification".
3. **Отмена уведомления**: Введите ID уведомления и нажмите "Cancel Notification".
4. **Просмотр уведомлений**: Нажмите "Load Notifications" для отображения списка всех уведомлений с их статусами.

UI позволяет тестировать сервис без ручных curl-запросов и наглядно видеть работу.

## Архитектура

- **Handlers**: Обработка HTTP-запросов (internal/handler/).
- **Services**: Бизнес-логика (internal/service/).
- **Repository**: Работа с БД (internal/repository/).
- **Queue**: Интеграция с RabbitMQ (internal/rabbitmq/).
- **Cache**: Кэширование через Redis (internal/cache/redis/).
- **Sender**: Отправка уведомлений (internal/sender/).
- **UI**: Статические файлы (static/).

## Тестирование

- Используйте UI для ручного тестирования.
- Или копируйте curl-команды выше для тестирования API.

## Расширение

- Добавить новые каналы отправки в internal/sender/.

